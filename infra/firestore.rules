rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    function isCertified() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.certified == true;
    }
    function isAdmin() {
      return get(/databases/$(database)/documents/admins/$(request.auth.uid)).exists;
    }

    // Users
    match /users/{uid} {
      allow read: if isAuthenticated();
      allow create: if isOwner(uid);
      allow update: if isOwner(uid) && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['coins', 'premium', 'badges', 'certified']);
      // Champs sensibles interdits en client write
    }

    // Groups
    match /groups/{groupId} {
      allow read: if isAuthenticated();
      allow create: if false; // Seulement via callable
      allow update: if false; // Seulement via callable
    }

    // Letter threads
    match /letterThreads/{threadId} {
      allow read: if request.auth.uid in resource.data.participants;
      allow create: if request.auth.uid in request.resource.data.participants && request.resource.data.participants.size() == 2;
      allow update: if request.auth.uid in resource.data.participants;
    }

    // Letter messages
    match /letterMessages/{messageId} {
      allow read: if request.auth.uid in get(/databases/$(database)/documents/letterThreads/$(resource.data.threadId)).data.participants;
      allow create: if request.auth.uid in get(/databases/$(database)/documents/letterThreads/$(request.resource.data.threadId)).data.participants && request.auth.uid == request.resource.data.authorUid;
    }

    // Purchases
    match /purchases/{purchaseId} {
      allow read: if isOwner(resource.data.uid);
      allow write: if false; // Seulement serveur
    }

    // Reports
    match /reports/{reportId} {
      allow create: if isAuthenticated() && isCertified();
      allow read: if isAdmin();
      allow update: if isAdmin();
    }
  }
}
